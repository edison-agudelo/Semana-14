{% extends "base.html" %}
{% block title %}Caso pr√°ctico RL{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    table td {
        width: 42px;
        height: 42px;
        text-align: center;
        vertical-align: middle;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}

<!-- TARJETA DE INTRODUCCI√ìN -->
<div class="card-custom mb-4">
    <h2>üß™ Caso Pr√°ctico: Entrenamiento con Q-Learning</h2>
    <p>
        En este caso pr√°ctico implementamos un agente basado en <b>Q-Learning</b> dentro de un entorno
        <b>GridWorld 5x5</b>. Desde esta interfaz puedes:
    </p>
    <ul>
        <li>Configurar par√°metros clave del aprendizaje.</li>
        <li>Entrenar al agente y visualizar la recompensa por episodio.</li>
        <li>Ejecutar la pol√≠tica aprendida y ver la trayectoria en el grid.</li>
        <li>Interpretar el comportamiento del agente con retroalimentaci√≥n num√©rica.</li>
    </ul>
</div>

<h1 class="mb-4">GridWorld con Q-Learning</h1>

<div class="row">

    <!-- PANEL IZQUIERDO -->
    <div class="col-md-4">

        <div class="card-custom mb-4">
            <h4 class="mb-3">‚öôÔ∏è Par√°metros de Entrenamiento</h4>

            <form id="train-form">

                <div class="mb-2">
                    <label class="form-label">Episodios</label>
                    <input type="number" id="episodes" class="form-control" value="500">
                </div>

                <div class="mb-2">
                    <label class="form-label">M√°x. pasos por episodio</label>
                    <input type="number" id="max_steps" class="form-control" value="100">
                </div>

                <div class="mb-2">
                    <label class="form-label">Œ± (Learning rate)</label>
                    <input type="number" step="0.01" id="alpha" class="form-control" value="0.1">
                </div>

                <div class="mb-2">
                    <label class="form-label">Œ≥ (Discount factor)</label>
                    <input type="number" step="0.01" id="gamma" class="form-control" value="0.99">
                </div>

                <div class="mb-2">
                    <label class="form-label">Œµ inicial</label>
                    <input type="number" step="0.01" id="epsilon" class="form-control" value="1.0">
                </div>

                <div class="mb-2">
                    <label class="form-label">Œµ m√≠nimo</label>
                    <input type="number" step="0.01" id="epsilon_min" class="form-control" value="0.01">
                </div>

                <div class="mb-2">
                    <label class="form-label">Decay de Œµ</label>
                    <input type="number" step="0.001" id="epsilon_decay" class="form-control" value="0.995">
                </div>

                <button type="button" id="btn-train"
                        class="btn btn-success mt-3 w-100 shadow-sm">
                    üöÄ Iniciar Entrenamiento
                </button>

            </form>
        </div>

        <!-- INDICADORES -->
        <div class="card-custom">
            <h4 class="mb-3">üìä Indicadores de Progreso</h4>

            <p>Episodios entrenados: <b id="lbl-episodes">0</b></p>
            <p>Œµ final: <b id="lbl-epsilon">-</b></p>
            <p>Recompensa promedio (√∫ltimos 50 episodios): <b id="lbl-avg-reward">-</b></p>

            <button type="button" id="btn-test"
                    class="btn btn-primary mt-3 w-100 shadow-sm">
                ‚ñ∂Ô∏è Probar pol√≠tica aprendida
            </button>
        </div>
    </div>

    <!-- PANEL DERECHO -->
    <div class="col-md-8">

        <div class="card-custom mb-4">
            <h4>üìà Recompensa por Episodio</h4>
            <canvas id="rewardChart" height="120"></canvas>
        </div>

        <div class="card-custom">
            <h4>üß≠ Trayectoria del Agente (GridWorld 5x5)</h4>

            <div id="grid-container" class="mt-3"></div>

            <p class="mt-3">
                Recompensa total del episodio: <b id="lbl-total-reward">-</b>
            </p>
        </div>

    </div>

</div>

{% endblock %}

{% block scripts %}
<script>

let rewardChart = null;

/* =====================================================
   CREAR GRID
===================================================== */
function createGrid(trajectory = null) {
    const container = document.getElementById("grid-container");
    container.innerHTML = "";

    const size = 5;
    const table = document.createElement("table");
    table.className = "table table-bordered";

    for (let r = 0; r < size; r++) {
        const row = document.createElement("tr");

        for (let c = 0; c < size; c++) {
            const cell = document.createElement("td");

            // Inicio
            if (r === 0 && c === 0) {
                cell.innerText = "S";
                cell.classList.add("table-secondary");
            }

            // Meta
            if (r === 4 && c === 4) {
                cell.innerText = "G";
                cell.classList.add("table-success");
            }

            // Obst√°culos
            if ((r === 1 && c === 1) || (r === 2 && c === 3)) {
                cell.classList.add("table-dark");
            }

            // Trayectoria aprendida
            if (trajectory) {
                const step = trajectory.find(t => t.row === r && t.col === c);

                if (step) {
                    cell.classList.add("table-warning");
                    cell.innerText = (cell.innerText || "") + " ‚Ä¢";
                }
            }

            row.appendChild(cell);
        }

        table.appendChild(row);
    }

    container.appendChild(table);
}

/* =====================================================
   ENTRENAR AGENTE
===================================================== */
document.getElementById("btn-train").addEventListener("click", async () => {

    const payload = {
        episodes: parseInt(document.getElementById("episodes").value),
        max_steps: parseInt(document.getElementById("max_steps").value),
        alpha: parseFloat(document.getElementById("alpha").value),
        gamma: parseFloat(document.getElementById("gamma").value),
        epsilon: parseFloat(document.getElementById("epsilon").value),
        epsilon_min: parseFloat(document.getElementById("epsilon_min").value),
        epsilon_decay: parseFloat(document.getElementById("epsilon_decay").value)
    };

    const resp = await fetch("/api/rl/train", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
    });

    const data = await resp.json();

    if (!resp.ok) {
        alert("Error durante el entrenamiento");
        return;
    }

    document.getElementById("lbl-episodes").innerText = data.episodes;
    document.getElementById("lbl-epsilon").innerText =
        data.epsilons[data.epsilons.length - 1].toFixed(3);
    document.getElementById("lbl-avg-reward").innerText =
        data.avg_reward_last_50.toFixed(2);

    // GR√ÅFICA
    const ctx = document.getElementById("rewardChart").getContext("2d");

    if (rewardChart) rewardChart.destroy();

    rewardChart = new Chart(ctx, {
        type: "line",
        data: {
            labels: data.rewards.map((_, i) => i + 1),
            datasets: [{
                label: "Recompensa por Episodio",
                data: data.rewards,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: true }
            }
        }
    });
});

/* =====================================================
   PROBAR POL√çTICA
===================================================== */
document.getElementById("btn-test").addEventListener("click", async () => {
    const resp = await fetch("/api/rl/run_episode");
    const data = await resp.json();

    if (!resp.ok) {
        alert(data.error || "Error ejecutando la pol√≠tica");
        return;
    }

    createGrid(data.trajectory);
    document.getElementById("lbl-total-reward").innerText =
        data.total_reward.toFixed(2);
});

/* GRID INICIAL */
createGrid();

</script>
{% endblock %}
